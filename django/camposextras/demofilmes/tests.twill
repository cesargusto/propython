##############################################################################
# Para funcionar, este script de testes depende de três pré-condições:
#
#  1) o site tem que estar rodando na URL e porta informada no argumento -u
#     do comando twill-sh. Por exemplo:
#       $ twill-sh -u http://127.0.0.1:8000/demo/ tests.twill
#      
#  2) a URL acima deve apontar para view nomeada 'demofilmes.indice' (note que
#     a parte "demo" da URL é definida no ROOT_URLCONF, ou seja, no urls.py da
#     raiz da instância do Django, e não no urls.py da aplicação demofilmes)
#
#  3) a fixture dois-filmes.json deve ser usada, ou qualquer uma que não tenha
#     os filmes abaixo, que serão criados nos testes:
#       - Das Boot (1981)
#       - 2001, A Space Odyssey (1968)
#       - Brazil (1985)
##############################################################################

# Armazenar url da página inicial da aplicação para facilitar a navegação
setglobal HOME __url__

##############################################################################
# Acesso à página índice da aplicação `demofilmes`

find 'Lista de Filmes'
find 'Apocalypse Now \(1979\)'
find 'Não por acaso'
    
##############################################################################
# Acesso à página de detalhes do primeiro filme

follow 'Apocalypse Now'
find 'Apocalypse Now \(1979\)'
find 'diretor.*\n.*Coppola'
find 'produtor.*\n.*Coppola'
find 'ator.*\n.*Brando'
find 'ator.*\n.*Duvall'
find 'ator.*\n.*Sheen'
follow 'Voltar para a lista'
url $HOME

##############################################################################
# Cadastro básico de um filme, view 'demofilmes.simples'

follow 'apenas título e ano'
fv 1 titulo 'Das Boot'
fv 1 ano '1981'
submit

url '/ver/\d+/'
find 'Das Boot \(1981\)'
follow 'Voltar para a lista'

find 'Das Boot \(1981\)'

##############################################################################
# Cadastro básico de um filme, view 'demofilmes.cadastrar'

follow 'título, ano e créditos'
fv 1 titulo '2001, A Space Odyssey'
fv 1 ano '1968'
submit

url '/ver/\d+/'
find '2001, A Space Odyssey \(1968\)'
follow 'Voltar para a lista'

find '2001, A Space Odyssey \(1968\)'

##############################################################################
# Cadastro completo de um filme, view 'demofilmes.cadastrar'

follow 'título, ano e créditos'
fv 1 titulo Brazil
fv 1 ano 1985
fv 1 credito_set-0-nome 'Terry Gilliam'
fv 1 credito_set-0-papel diretor
fv 1 credito_set-1-nome 'Jonathan Pryce'
fv 1 credito_set-1-papel ator
fv 1 credito_set-2-nome 'Robert De Niro'
fv 1 credito_set-2-papel ator
submit

url '/ver/\d+/'
find 'Brazil \(1985\)'
find 'diretor.*\n.*Gilliam'
find 'ator.*\n.*Pryce'
find 'ator.*\n.*De Niro'

##############################################################################
# Edição de um filme, view 'demofilmes.editar'

go $HOME
follow 'Brazil'
follow 'Editar título/ano e créditos'
fv 1 titulo 'Brazil, o filme'
fv 1 ano 1985
fv 1 credito_set-0-nome 'Terry Gilliam'
fv 1 credito_set-0-papel diretor
fv 1 credito_set-1-nome 'Jonathan Pryce'
fv 1 credito_set-1-papel ator
fv 1 credito_set-2-nome 'Mr. De Niro'
fv 1 credito_set-2-papel ator
fv 1 credito_set-3-nome 'Kim Greist'
fv 1 credito_set-3-papel ator
submit

url '/ver/\d+/'
find 'Brazil, o filme \(1985\)'
find 'diretor.*\n.*Gilliam'
find 'ator.*\n.*Pryce'
find 'ator.*\n.*Mr\. De Niro'
find 'ator.*\n.*Greist'


##############################################################################
# Apagar um crédito, view 'demofilmes.editar'

go $HOME
follow 'Brazil'
follow 'Editar título/ano e créditos'
fv 1 credito_set-1-DELETE 'on'
submit

url '/ver/\d+/'
find 'Brazil, o filme \(1985\)'
notfind 'ator.*\n.*Pryce'

##############################################################################
# Apagar os filmes criados neste teste

go $HOME
follow 'Brazil'
submit 1
find 'Confirmar remoção?'
submit 1
find 'Lista de Filmes'
notfind 'Brazil'

follow '2001'
submit 1
find 'Confirmar remoção?'
submit 1
find 'Lista de Filmes'
notfind '2001'

follow 'Das Boot'
submit 1
find 'Confirmar remoção?'
submit 1
find 'Lista de Filmes'
notfind 'Das Boot'
